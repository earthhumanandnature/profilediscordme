<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Discord Profile</title>

  <link rel="icon" href="https://discord.com/assets/847541504914fd33810e70a0ea73177e.ico">
  <link rel="stylesheet" href="style.css">

  <style>
    #water-bg {
      position: fixed;
      inset: 0;
      z-index: -10;
      display: none;
    }

    #water-controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(0,0,0,0.45);
      border-radius: 14px;
      color: #fff;
      z-index: 20;
      align-items: center;
      font-size: 12px;
    }

    #water-controls label {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #water-controls input[type="range"] {
      width: 110px;
    }

    #water-controls button {
      background: #2b7cff;
      color: #fff;
      border: none;
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>

<canvas id="water-bg"></canvas>

<div id="water-controls">
  <label>
    ƒê·ªô cao s√≥ng
    <input id="waveHeight" type="range" min="0" max="3" step="0.1" value="1.2">
  </label>
  <label>
    Gi√≥
    <input id="waveSpeed" type="range" min="0" max="4" step="0.1" value="1.5">
  </label>
  <label>
    M√†u s√≥ng
    <input id="waveColor" type="color" value="#2b8cff">
  </label>
  <button id="pulseBtn">üåä T·∫°o s√≥ng</button>
</div>

<audio id="bgMusic" loop preload="auto">
  <source src="music.mp3" type="audio/mpeg">
</audio>

<div class="container">
  <div id="profile-card" class="card hidden"></div>
  <div id="welcome" class="welcome"></div>
</div>

<script src="script.js"></script>

<script type="module">
import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js';
import GUI from 'https://cdn.jsdelivr.net/npm/lil-gui@0.19/+esm';

const waterCanvas = document.getElementById('water-bg');

/* ====== (GI·ªÆ NGUY√äN TO√ÄN B·ªò CODE 3D C·ª¶A B·∫†N) ====== */

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000814);

const renderer = new THREE.WebGLRenderer({
  canvas: waterCanvas,
  antialias: true,
  alpha: true
});
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);

const params = {
  waveHeight: 1.8,
  waveSpeed: 1.0,
  waveFreq: 0.05,
  pulseStrength: 3.0,
  tiltStrength: 0.25
};

const SIZE = 200;
const geo = new THREE.PlaneGeometry(SIZE, SIZE, 256, 256);
geo.rotateX(-Math.PI / 2);

const pulses = [];

const uniforms = {
  uTime: { value: 0 },
  uPulseTime: { value: -10 },
  uPulseCenter: { value: new THREE.Vector2() },
  uPulseStrength: { value: params.pulseStrength },
  uWaveHeight: { value: params.waveHeight },
  uWaveSpeed: { value: params.waveSpeed },
  uWaveFreq: { value: params.waveFreq }
};

const mat = new THREE.ShaderMaterial({
  uniforms,
  vertexShader: document.querySelector('script[type="x-shader/x-vertex"]')?.textContent || `
    uniform float uTime;
    uniform float uWaveHeight;
    uniform float uWaveSpeed;
    uniform float uWaveFreq;
    uniform float uPulseTime;
    uniform float uPulseStrength;
    uniform vec2 uPulseCenter;
    varying float vH;
    void main(){
      vec3 p = position;
      float base =
        sin(p.x * uWaveFreq + uTime * uWaveSpeed) +
        cos(p.z * uWaveFreq + uTime * uWaveSpeed);
      float d = distance(p.xz, uPulseCenter);
      float pulse =
        sin(d * 1.5 - (uTime - uPulseTime) * 8.0)
        * exp(-d * 0.08)
        * uPulseStrength;
      p.y += base * uWaveHeight + pulse;
      vH = p.y;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(p,1.0);
    }
  `,
  fragmentShader: `
    varying float vH;
    void main(){
      vec3 deep = vec3(0.0,0.18,0.3);
      vec3 shallow = vec3(0.35,0.65,1.0);
      float h = clamp((vH + 3.0)/6.0,0.0,1.0);
      gl_FragColor = vec4(mix(deep,shallow,h),1.0);
    }
  `,
  side: THREE.DoubleSide
});

const water = new THREE.Mesh(geo, mat);
scene.add(water);

const camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0, SIZE * 0.9, 0);
camera.up.set(0,0,-1);
camera.lookAt(0,0,0);

/* ====== CONTROL ‚Äì PH·∫¶N ƒê∆Ø·ª¢C S·ª¨A ====== */

waveHeight.addEventListener('input', e=>{
  uniforms.uWaveHeight.value = +e.target.value;
});

waveSpeed.addEventListener('input', e=>{
  uniforms.uWaveSpeed.value = +e.target.value;
});

waveColor.addEventListener('input', e=>{
  const c = new THREE.Color(e.target.value);
  mat.fragmentShader = `
    varying float vH;
    void main(){
      vec3 deep = vec3(0.0,0.18,0.3);
      vec3 shallow = vec3(${c.r},${c.g},${c.b});
      float h = clamp((vH + 3.0)/6.0,0.0,1.0);
      gl_FragColor = vec4(mix(deep,shallow,h),1.0);
    }
  `;
  mat.needsUpdate = true;
});

pulseBtn.addEventListener('click',()=>{
  addPulse(0,0);
});

/* ====== SHOW CONTROL KHI LOGIN ====== */
new MutationObserver(()=>{
  const card = document.getElementById('profile-card');
  if(!card.classList.contains('hidden')){
    waterCanvas.style.display = 'block';
    document.getElementById('water-controls').style.display = 'flex';
  }
}).observe(document.getElementById('profile-card'),{attributes:true});
</script>

</body>
</html>
